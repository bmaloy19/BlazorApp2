@page "/garage"
@rendermode InteractiveServer
@using BlazorApp2.Data.Models
@using BlazorApp2.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject NavigationManager NavigationManager
@inject VehicleService VehicleService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>My Garage</PageTitle>

<div class="garage-container">
    <div class="garage-header">
        <div class="garage-header-content">
            <h1>My Garage</h1>
            <p class="garage-subtitle">Manage your vehicles and keep track of maintenance</p>
        </div>
        <div class="view-toggle">
            <button class="view-toggle-btn @(_viewMode == ViewMode.Card ? "active" : "")" @onclick="() => SetViewMode(ViewMode.Card)" title="Card View">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/>
                </svg>
            </button>
            <button class="view-toggle-btn @(_viewMode == ViewMode.List ? "active" : "")" @onclick="() => SetViewMode(ViewMode.List)" title="List View">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
        </div>
    </div>

    @if (_isLoading)
    {
        <LoadingState Message="Loading your vehicles..." />
    }
    else if (_viewMode == ViewMode.Card)
    {
        <div class="garage-grid">
            @foreach (var userVehicle in _userVehicles)
            {
                <VehicleCard 
                    Vehicle="userVehicle.Vehicle" 
                    UserVehicle="userVehicle"
                    DisplayMode="VehicleCard.Mode.Card"
                    OnClick="() => ViewVehicle(userVehicle)" />
            }

            <AddVehicleCard 
                DisplayMode="AddVehicleCard.Mode.Card"
                OnClick="OpenAddVehicleModal" />
        </div>
    }
    else
    {
        <div class="garage-list">
            @foreach (var userVehicle in _userVehicles)
            {
                <VehicleCard 
                    Vehicle="userVehicle.Vehicle" 
                    UserVehicle="userVehicle"
                    DisplayMode="VehicleCard.Mode.List"
                    OnClick="() => ViewVehicle(userVehicle)" />
            }

            <AddVehicleCard 
                DisplayMode="AddVehicleCard.Mode.List"
                OnClick="OpenAddVehicleModal" />
        </div>
    }
</div>

@code {
    private ViewMode _viewMode = ViewMode.Card;
    private List<UserVehicle> _userVehicles = new();
    private bool _isLoading = true;
    private string? _userId;
    
    private enum ViewMode { Card, List }

    protected override async Task OnInitializedAsync()
    {
        await LoadVehicles();
    }

    private async Task LoadVehicles()
    {
        _isLoading = true;
        
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            _userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(_userId))
            {
                _userVehicles = await VehicleService.GetUserVehiclesAsync(_userId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading vehicles: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private void SetViewMode(ViewMode mode)
    {
        _viewMode = mode;
        StateHasChanged();
    }
    
    private void OpenAddVehicleModal()
    {
        NavigationManager.NavigateTo("/garage/add");
    }
    
    private void ViewVehicle(UserVehicle userVehicle)
    {
        NavigationManager.NavigateTo($"/garage/vehicle/{userVehicle.VehicleId}");
    }
}
