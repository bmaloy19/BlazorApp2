@page "/garage/add"
@rendermode InteractiveServer
@using BlazorApp2.Data.Models
@using BlazorApp2.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@inject NavigationManager NavigationManager
@inject VehicleService VehicleService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Add New Vehicle</PageTitle>

<div class="add-vehicle-container">
    <div class="add-vehicle-header">
        <button class="btn-back" @onclick="GoBack">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Back to Garage
        </button>
        <h1>Add New Vehicle</h1>
        <p class="add-vehicle-subtitle">Add a vehicle by entering VIN or selecting manually</p>
    </div>

    <div class="input-method-toggle">
        <button class="method-btn @(_inputMethod == InputMethod.Vin ? "active" : "")" @onclick="() => SetInputMethod(InputMethod.Vin)">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2zm6 2.5a.5.5 0 0 1 .5.5v2.5h2a.5.5 0 0 1 0 1h-2V11a.5.5 0 0 1-1 0V8.5h-2a.5.5 0 0 1 0-1h2V5a.5.5 0 0 1 .5-.5z"/>
            </svg>
            Decode VIN
        </button>
        <button class="method-btn @(_inputMethod == InputMethod.Manual ? "active" : "")" @onclick="() => SetInputMethod(InputMethod.Manual)">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                <path d="M3 4h10v1H3V4zm0 3h10v1H3V7zm0 3h6v1H3v-1z"/>
            </svg>
            Select Manually
        </button>
    </div>

    <div class="add-vehicle-content">
        @if (_inputMethod == InputMethod.Vin)
        {
            <VinDecoderCard OnVehicleDecoded="OnVinDecoded" />
        }
        else
        {
            <CarSelectorCard OnVehicleSelected="OnManualSelection" />
        }

        @* Vehicle Preview & Additional Details *@
        @if (_vehicle is not null)
        {
            <div class="vehicle-preview-card">
                <div class="preview-header">
                    <h3>Vehicle Details</h3>
                    <span class="preview-badge">Preview</span>
                </div>
                
                <div class="preview-main">
                    <div class="preview-title">
                        <div class="preview-title-top">
                            <span class="year-badge">@_vehicle.Year</span>
                            @if (!string.IsNullOrEmpty(_vehicle.BodyClass))
                            {
                                <span class="body-type-badge">@_vehicle.BodyClass</span>
                            }
                        </div>
                        <h2>@_makeName @_vehicle.Model</h2>
                        @if (!string.IsNullOrEmpty(_vehicle.Series) || !string.IsNullOrEmpty(_vehicle.Trim))
                        {
                            <p class="trim">
                                @if (!string.IsNullOrEmpty(_vehicle.Series))
                                {
                                    <span>@_vehicle.Series</span>
                                }
                                @if (!string.IsNullOrEmpty(_vehicle.Series) && !string.IsNullOrEmpty(_vehicle.Trim))
                                {
                                    <span> Â· </span>
                                }
                                @if (!string.IsNullOrEmpty(_vehicle.Trim))
                                {
                                    <span>@_vehicle.Trim</span>
                                }
                            </p>
                        }
                        @if (!string.IsNullOrEmpty(_vehicle.Engine) || !string.IsNullOrEmpty(_vehicle.Drivetrain))
                        {
                            <div class="preview-specs-row">
                                @if (!string.IsNullOrEmpty(_vehicle.Engine))
                                {
                                    <span class="spec-badge">@_vehicle.Engine</span>
                                }
                                @if (!string.IsNullOrEmpty(_vehicle.Drivetrain))
                                {
                                    <span class="spec-badge">@_vehicle.Drivetrain</span>
                                }
                            </div>
                        }
                    </div>
                </div>

                <div class="preview-details">
                    @if (!string.IsNullOrEmpty(_vehicle.Vin))
                    {
                        <div class="detail-row">
                            <span class="label">VIN</span>
                            <span class="value vin-value">@_vehicle.Vin</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(_vehicle.VehicleType))
                    {
                        <div class="detail-row">
                            <span class="label">Type</span>
                            <span class="value">@_vehicle.VehicleType</span>
                        </div>
                    }
                </div>

                <div class="additional-fields">
                    <h4>Additional Information (Optional)</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="color">Color</label>
                            <input type="text" id="color" class="form-control" @bind="_vehicle.Color" placeholder="e.g. Midnight Black" />
                        </div>
                        <div class="form-group">
                            <label for="plate">License Plate</label>
                            <input type="text" id="plate" class="form-control" @bind="_vehicle.LicensePlate" placeholder="ABC-1234" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="mileage">Current Mileage</label>
                            <input type="number" id="mileage" class="form-control" @bind="_vehicle.CurrentMiles" placeholder="e.g. 45000" />
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <input type="text" id="notes" class="form-control" @bind="_vehicle.Notes" placeholder="Any additional notes..." />
                        </div>
                    </div>
                </div>

                <div class="preview-actions">
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger">@_errorMessage</div>
                    }
                    <button class="btn btn-secondary" @onclick="ClearVehicle" disabled="@_isSaving">Clear</button>
                    <button class="btn btn-primary" @onclick="SaveVehicle" disabled="@_isSaving">
                        @if (_isSaving)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                            </svg>
                            <span>Add to Garage</span>
                        }
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private InputMethod _inputMethod = InputMethod.Vin;
    private Vehicle? _vehicle;
    private string _makeName = string.Empty; // For display purposes before save
    private bool _isSaving = false;
    private string? _errorMessage;

    private enum InputMethod { Vin, Manual }

    private void SetInputMethod(InputMethod method)
    {
        _inputMethod = method;
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/garage");
    }

    private void OnVinDecoded((Vehicle Vehicle, string MakeName) data)
    {
        _vehicle = data.Vehicle;
        _makeName = data.MakeName;
        _errorMessage = null;
        StateHasChanged();
    }

    private void OnManualSelection((Vehicle Vehicle, string MakeName) data)
    {
        _vehicle = data.Vehicle;
        _makeName = data.MakeName;
        _errorMessage = null;
        StateHasChanged();
    }

    private void ClearVehicle()
    {
        _vehicle = null;
        _makeName = string.Empty;
        _errorMessage = null;
    }

    private async Task SaveVehicle()
    {
        if (_vehicle is null) return;

        _isSaving = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                _errorMessage = "You must be logged in to add a vehicle.";
                return;
            }

            await VehicleService.AddVehicleAsync(_vehicle, userId, makeName: _makeName);
            NavigationManager.NavigateTo("/garage");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to save vehicle: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }
}
