@page "/Account/RegisterConfirmation"

@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using BlazorApp2.Data

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager
@inject IConfiguration Configuration

<PageTitle>Register confirmation</PageTitle>

<div class="auth-status">
    <div class="auth-status-icon info">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z"/>
        </svg>
    </div>
    
    <h1>Check Your Email</h1>
    
    <StatusMessage Message="@statusMessage"/>
    
    @if (IsDevEnvironment && emailConfirmationLink is not null)
    {
        <div class="auth-alert info">
            <div>
                <h5>Development Mode (@AppEnvironment)</h5>
                <p>In development, emails are saved to the <code>dev-emails</code> folder in your project.</p>
                <p>For convenience, you can confirm your account directly:</p>
            </div>
        </div>
        <div class="auth-actions">
            <a href="@emailConfirmationLink" class="btn btn-primary">Confirm Email Now</a>
        </div>
    }
    else
    {
        <p class="auth-status-message">
            We've sent a confirmation link to <strong>@Email</strong>
        </p>
        <p class="auth-status-hint" style="margin-bottom: var(--space-xl);">
            Please check your email and click the confirmation link to activate your account.
            If you don't see the email, check your spam folder.
        </p>
        
        <div class="auth-actions">
            <a href="Account/Login" class="btn btn-outline">Back to Login</a>
            <a href="Account/ResendEmailConfirmation?email=@Uri.EscapeDataString(Email ?? "")" class="btn btn-link">
                Didn't receive the email? Resend
            </a>
        </div>
    }
</div>

@code {
    private string? emailConfirmationLink;
    private string? statusMessage;
    
    // AppEnvironment values: "LocalDev", "UAT", "Prod"
    private string AppEnvironment => Configuration["AppEnvironment"] ?? "Prod";
    private bool IsDevEnvironment => AppEnvironment is "LocalDev" or "UAT";

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery] private string? Email { get; set; }

    [SupplyParameterFromQuery] private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Email is null)
        {
            RedirectManager.RedirectTo("");
        }

        var user = await UserManager.FindByEmailAsync(Email);
        if (user is null)
        {
            HttpContext.Response.StatusCode = StatusCodes.Status404NotFound;
            statusMessage = "Error finding user for unspecified email";
        }
        else if (IsDevEnvironment)
        {
            // In LocalDev or UAT, show direct confirmation link for convenience
            var userId = await UserManager.GetUserIdAsync(user);
            var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
            code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
            emailConfirmationLink = NavigationManager.GetUriWithQueryParameters(
                NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
                new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });
        }
    }

}